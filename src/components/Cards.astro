---
const posts = Object.values(import.meta.glob('../pages/cards/*.md', { eager: true }));
---

<div class="cards-wrapper">
  <div class="cards">
    {posts.map(post =>
      <div class="card" style={`background-color: ${post.frontmatter.color}; --degree: ${post.frontmatter.rotation};`}>
        {<Fragment set:html={post.compiledContent()}/>}
      </div>
      )
    }
  </div>
</div>

<script>
  const section = document.querySelector('.cards-wrapper') as HTMLElement;
  const cardsContainer = document.querySelector('.cards') as HTMLElement;
  const cards = document.querySelectorAll('.card') as NodeListOf<HTMLElement>;

  const totalCards = cards.length;
  const scrollPerCard = window.innerHeight * 1.5; // сколько пикселей скролла на одну карточку
  const totalScrollHeight = scrollPerCard * totalCards;

  // Устанавливаем высоту секции для создания "виртуального" скролла
  section.style.height = `${totalScrollHeight + window.innerHeight}px`;

  cards.forEach(card => {
    card.style.setProperty('--progress', '0');
  });

  function updateCardsProgress() {
    const sectionRect = section.getBoundingClientRect();
    const sectionTop = -sectionRect.top; // сколько проскроллено от начала секции

    // Если секция ещё не началась
    if (sectionTop < 0) {
      cards.forEach(card => card.style.setProperty('--progress', '0'));
      return;
    }

    // Если секция полностью пройдена
    if (sectionTop >= totalScrollHeight) {
      cards.forEach(card => card.style.setProperty('--progress', '1'));
      return;
    }

    // Вычисляем progress для каждой карточки
    cards.forEach((card, index) => {
      const cardStart = index * scrollPerCard;
      const cardEnd = cardStart + scrollPerCard;

      let progress = 0;
      if (sectionTop >= cardEnd) {
        progress = 1;
      } else if (sectionTop > cardStart) {
        progress = (sectionTop - cardStart) / scrollPerCard;
      }

      card.style.setProperty('--progress', progress.toString());
    });
  }

  // Фиксируем контейнер с карточками при скролле
  function updateStickyPosition() {
    const sectionRect = section.getBoundingClientRect();

    if (sectionRect.top <= 0 && sectionRect.bottom > window.innerHeight) {
      cardsContainer.style.position = 'fixed';
      cardsContainer.style.top = '0';
      cardsContainer.style.left = '0';
      cardsContainer.style.width = '100%';
    } else if (sectionRect.bottom <= window.innerHeight) {
      cardsContainer.style.position = 'absolute';
      cardsContainer.style.top = `${totalScrollHeight}px`;
      cardsContainer.style.left = '0';
      cardsContainer.style.width = '100%';
    } else {
      cardsContainer.style.position = 'relative';
      cardsContainer.style.top = '0';
    }
  }

  window.addEventListener('scroll', () => {
    updateCardsProgress();
    updateStickyPosition();
  }, { passive: true });

  // Инициализация
  updateCardsProgress();
  updateStickyPosition();
</script>
