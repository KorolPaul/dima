---
const posts = Object.values(import.meta.glob('../pages/projects/*.md', { eager: true }));
---

<div class="projects-list">
  <div class="projects-list_holder">
  {posts.map(post => (
      <div class="projects-list_item" data-title={post.frontmatter.title}>
        <div class="projects-list_item-name">
          <img class="projects-list_item-icon" src={post.frontmatter.thumbnailSmall}>
          <h3 class="projects-list_item-title" set:html={post.frontmatter.subtitle} />
        </div>
        <div class="projects-list_item-video">
          <video src={post.frontmatter.thumbnailVideo} muted autoplay playsinline loop></video>
        </div>
      </div>
    ))}
  </div>
</div>



<script>
  const projectCards = document.querySelectorAll('.projects-list_item');
  const popupWrapper = document.querySelector('.popup-wrapper');
  const fade = document.querySelector('.fade');

  function togglePopup(e?: Event) {
    e?.preventDefault();

    document.body.classList.toggle('popup-opened');
  }

  document.querySelectorAll('.js-popup-toggle').forEach((el) => el.addEventListener('click', togglePopup));

  function openProject(e: Event) {
    document.body.classList.toggle('popup-opened');

    const projectTitle = e.currentTarget.dataset.title;

    const targetElement = document.querySelector(`.popup_content .project[title="${projectTitle}"]`);
    const color = targetElement.dataset.color;
    fade.style.backgroundColor = color;

    if (targetElement) {
      targetElement.scrollIntoView({
        behavior: 'auto',
        block: 'start',
        inline: 'nearest',
      });
    }
  }

  projectCards.forEach((el) => el.addEventListener('click', openProject));


  const observerCallback = (entries, observer) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const color = entry.target.dataset.color;
        fade.style.backgroundColor = color;
      }
    })
  }

  const options = {
    rootMargin: '-30% 0px -30% 0px',
    threshold: 0,
  }

  const observer = new IntersectionObserver(observerCallback, options);

  document.querySelectorAll('.popup .project').forEach((el) => {
    observer.observe(el);
  });

</script>
